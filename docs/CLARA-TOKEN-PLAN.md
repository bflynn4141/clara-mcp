# $CLARA Token: Implementation Plan

> Consolidated plan from security, solidity, and UX review. All decisions locked in.

## System Overview

$CLARA is a staking token on Base that gives holders a proportional share of x402 fee revenue (paid in USDC) generated by all Clara MCP users.

```
User does wallet_send/swap/call/sign
     ↓
clara-proxy returns HTTP 402 (~$0.01 USDC)
     ↓
wallet_pay_x402 auto-pays
     ↓
x402 facilitator settles USDC → ClaraStaking contract (DIRECT, no proxy custody)
     ↓
CLARA stakers claim proportional USDC anytime
```

## Contracts

### 1. ClaraToken

| Property | Value |
|---|---|
| Type | ERC-20 with ERC-2612 permit |
| Supply | 100,000,000 CLARA (fixed, minted at deploy) |
| Decimals | 18 |
| Proxy | **None (immutable)** |
| Chain | Base (8453) |
| Admin | None after deployment |

No mint, no burn, no blocklist, no upgradeability. Deploy and forget.

### 2. ClaraStaking

| Property | Value |
|---|---|
| Pattern | Modified Synthetix RewardPerToken (deposit-triggered) |
| Proxy | UUPS + 7-day timelock |
| Staking asset | CLARA (18 decimals) |
| Reward asset | USDC (6 decimals) |
| Fee source | x402 facilitator (direct settlement) |
| Cooldown | None at launch (can add via UUPS upgrade) |
| Functions | `stake()`, `unstake()`, `claim()`, `exit()`, `deposit()`, `getClaimable()`, `stakeWithPermit()` |

Combines staking + fee distribution in one contract. Holds both staked CLARA and accumulated USDC rewards.

### 3. MerkleDrop

| Property | Value |
|---|---|
| Type | Merkle distributor for airdrop |
| Proxy | **None (immutable)** |
| Root | Set once in constructor |
| Deadline | 6 months from deploy |
| Eligibility | GitHub + X identity verification |

## Locked Decisions

| Decision | Choice | Rationale |
|---|---|---|
| Chain | Base mainnet | Clara's home chain, cheapest gas |
| Token supply | Fixed 100M, no minting | Simple, no inflation |
| ClaraToken proxy | **Immutable** | Nothing to upgrade, eliminates attack surface |
| ClaraStaking proxy | UUPS + 7-day timelock | Holds user funds, needs upgrade path for fixes |
| Staking + FeeDistributor | **Merged (2 contracts total)** | Synthetix pattern, battle-tested, simpler |
| Reward token | USDC (real yield) | Not circular tokenomics |
| Fee distribution | On-claim, deposit-triggered | No time-based emissions, no epochs |
| Fee settlement | x402 facilitator → ClaraStaking.deposit() **directly** | Eliminates proxy custody risk |
| Cooldown | None at launch | Base sequencer prevents front-running, add later via UUPS if needed |
| Liquidity | Aerodrome volatile CLARA/USDC pool | Ecosystem-native, works with Li.Fi |
| Onboarding | 25 free ops → x402 auto-pay | One payment system, progressive disclosure |
| Airdrop | GitHub + X identity, CLI-native claim | Sybil-resistant, no external dApp needed |
| Admin (launch) | TBD multisig → TimelockController | Security engineer to recommend composition |
| Payment system | x402 only (kill ClaraCredits deposit model) | One payment path, not two |
| ERC-2612 Permit | Yes on ClaraToken | Enables gasless staking via `stakeWithPermit()` |
| Deployment tool | Foundry | Faster, native Solidity scripts, built-in fuzzing |

## Token Allocation

| Allocation | Amount | % | Notes |
|---|---|---|---|
| Treasury | 40,000,000 | 40% | Protocol development, grants, future liquidity |
| Staking incentives | 25,000,000 | 25% | Optional CLARA rewards to bootstrap staking |
| Aerodrome LP | 10,000,000 | 10% | Paired with USDC, sets launch price |
| Team | 15,000,000 | 15% | 1-year cliff, 3-year linear vest |
| Airdrop | 10,000,000 | 10% | GitHub + X verified developers |

All 100M minted to treasury multisig at deploy. Treasury distributes to vesting, LP, MerkleDrop.

## The User Loop

### Phase 1: Zero-Friction Start (0-2 min)

1. `wallet_setup email="user@example.com"` — wallet created, 25 free ops granted
2. `wallet_dashboard` — shows empty wallet + free tier counter
3. Any write op (send, swap, sign) — works free, counter decrements

### Phase 2: Real Usage (2-5 min)

4. Free ops run out → x402 kicks in (~$0.01 USDC/op, auto-pay)
5. User deposits USDC to their wallet on Base (or already has some)
6. x402 fees are invisible-ish: one-line footer on every write op

### Phase 3: Discovery (5-10 min)

7. `wallet_opportunities` — auto-detects CLARA staking, shows APY
8. `wallet_claim_airdrop` — GitHub/X OAuth → free CLARA (OR `wallet_swap` USDC→CLARA)
9. `wallet_call` → ClaraStaking.stake() — one transaction

### Phase 4: The Aha Moment

10. Next time user checks `wallet_dashboard` → "Claimable: $X.XX USDC"
11. `wallet_call` → ClaraStaking.claim() — real USDC appears in wallet
12. User realizes: "I'm earning money from a tool I already use"

## Clara MCP Changes Required

### New Tool: `wallet_claim_airdrop`

CLI-native airdrop claim flow:
1. Generate verification link (GitHub/X OAuth)
2. User clicks link, authorizes, returns to CLI
3. Call MerkleDrop contract to claim CLARA

### Modified: `wallet_dashboard`

Add "CLARA Staking" section when user has staked CLARA:
```
## CLARA Staking
Staked: 1,000 CLARA
Share: 0.042% of total stake
Claimable: $2.18 USDC  ←  claim with wallet_call
Earned Total: $14.73 USDC
```

### Modified: `wallet_opportunities`

Auto-append CLARA staking section when:
- User has CLARA in wallet (staked or unstaked), OR
- User has used 10+ paid operations

### Modified: `wallet_setup`

- Show free tier counter: "You have 25 free operations"
- Default to email-based wallet (stronger nudge against machine-only)

### Modified: Tool response formatting

After free tier exhausted, append to every write op:
```
x402 fee: $0.01 | Today: $0.05/10.00
```

### Removed: ClaraCredits deposit flow

One payment system: free tier → x402. No separate "deposit to credits" path.

## Deployment Plan

### Phase 1: Core Contracts

```
1. Deploy ClaraToken (immutable, no proxy)
   - initialize(treasury = multisig address)
   - Mints 100M CLARA to treasury
   - Verify on BaseScan

2. Deploy ClaraStaking implementation
   - _disableInitializers() in constructor
   - Verify implementation on BaseScan

3. Deploy ClaraStaking proxy (ERC1967)
   - initialize(claraToken, USDC, feeSource = x402 facilitator)
   - Verify proxy on BaseScan

4. Deploy TimelockController
   - 7-day delay
   - Proposer = multisig
   - Executor = multisig

5. Transfer ClaraStaking ownership → TimelockController
```

### Phase 2: Liquidity

```
6. Treasury approves CLARA + USDC on Aerodrome Router
7. Create CLARA/USDC volatile pool
8. Add initial liquidity (10M CLARA + X USDC)
   - X determines launch price (see table below)
9. Verify pool on Aerodrome UI
```

| CLARA | USDC | Price | FDV |
|---|---|---|---|
| 10,000,000 | 50,000 | $0.005 | $500K |
| 10,000,000 | 100,000 | $0.01 | $1M |
| 10,000,000 | 200,000 | $0.02 | $2M |

### Phase 3: Distribution

```
10. Deploy MerkleDrop (immutable)
    - Set Merkle root (from GitHub+X identity data)
    - 6-month claim deadline
    - Fund with 10M CLARA from treasury

11. Deploy vesting for team allocation (15M CLARA)
    - 1-year cliff, 3-year linear

12. Configure x402 facilitator
    - Settlement address = ClaraStaking contract
    - Direct USDC transfer on each settlement
```

### Phase 4: Integration

```
13. Add wallet_claim_airdrop tool to Clara MCP
14. Modify wallet_dashboard to show CLARA staking section
15. Modify wallet_opportunities to auto-append CLARA staking
16. Implement free tier (25 ops) in clara-proxy or on-chain
17. Remove ClaraCredits deposit flow
18. Update wallet_setup messaging
19. Set up timelock monitoring (OpenZeppelin Defender / Tenderly)
```

## Security Checklist

- [ ] ClaraStaking: `_disableInitializers()` in implementation constructor
- [ ] ClaraStaking: ReentrancyGuard on all state-changing functions
- [ ] ClaraStaking: CEI pattern (update state before transfers)
- [ ] ClaraStaking: SafeERC20 for all token transfers
- [ ] ClaraStaking: `deposit()` restricted to feeSource only
- [ ] ClaraStaking: `deposit()` reverts when totalStaked == 0
- [ ] ClaraStaking: `recoverERC20()` cannot recover staked CLARA
- [ ] ClaraStaking: Storage gap (`uint256[50] private __gap`) for upgrade safety
- [ ] ClaraStaking: rewardPerTokenStored scaled by 1e18 for precision
- [ ] ClaraToken: No mint function exists (supply fixed at initialize)
- [ ] MerkleDrop: Root immutable (set in constructor)
- [ ] MerkleDrop: Double-claim protection via bitmap
- [ ] TimelockController: 7-day minimum delay
- [ ] TimelockController: Monitoring set up (alerts on CallScheduled events)
- [ ] Proxy implementation: Cannot be initialized directly (verify post-deploy)
- [ ] All contracts: Verified on BaseScan
- [ ] Test: Zero-staker deposit reverts
- [ ] Test: Precision with large staker counts + small deposits
- [ ] Test: Reentrancy on claim()
- [ ] Test: Full lifecycle (stake → deposit → claim → unstake)

## Known Risks Accepted

| Risk | Severity | Mitigation | Decision |
|---|---|---|---|
| Flash-loan staking attack | Critical | Base sequencer FIFO ordering; can add cooldown via UUPS upgrade | **Accept for now** |
| UUPS upgrade could drain staked CLARA + USDC | Critical | 7-day timelock + monitoring + multisig | **Accept (merged design is simpler)** |
| Rounding dust in reward math | Low | Scale by 1e18; accept dust as protocol property | **Accept** |
| Sybil airdrop farming | Medium | GitHub activity threshold + X verification | **Accept (mitigate with scoring)** |

## What to Build Next (v2 Ideas)

After shipping v1 and observing real usage:

1. **Cooldown mechanism** — If flash-loan attacks materialize, add via UUPS upgrade
2. **Governance** — If CLARA distribution is broad enough, add Governor contract for parameter changes
3. **Multi-reward tokens** — ClaraStaking could distribute additional reward tokens beyond USDC
4. **Cross-chain staking** — Accept CLARA staked on Ethereum/Arbitrum via bridge
5. **Dynamic fee pricing** — Different x402 costs for different operations (contract calls > sends)
6. **Net earnings display** — Dashboard shows "fees paid vs rewards earned" comparison
7. **Auto-compound** — Claim USDC → swap to CLARA → restake, all in one tx
8. **Separate immutable FeeDistributor** — If the merged design feels too risky after observation

## File References

| Document | Path | Author |
|---|---|---|
| Security review | `docs/security-review.md` | security-engineer |
| Solidity architecture | `docs/solidity-architecture.md` | solidity-engineer |
| UX design | `docs/ux-design.md` | ux-designer |
| This plan | `docs/CLARA-TOKEN-PLAN.md` | consolidated |
